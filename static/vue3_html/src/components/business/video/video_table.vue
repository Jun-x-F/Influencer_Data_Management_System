<template>
    <div class="video-table table_color">
        <!-- Êñ∞Â¢ûËßÜÈ¢ëÊäΩÂ±â -->
        <AddVideo v-model="isAdd" @close="handleDrawerClose" @update-success="handleUpdateSuccess" />

        <!-- Êõ¥Êñ∞ËßÜÈ¢ëÊäΩÂ±â -->
        <UpdateVideo v-if="updateDrawerVisible" v-model="updateDrawerVisible" :row-data="currentRow"
            @close="handleDrawerClose" @update-success="handleUpdateSuccess" />

        <el-card class="video_card">
            <!-- Ê∑ªÂä†ÊêúÁ¥¢Âå∫Âüü -->
            <div class="search-area">
                <div class="search-left">
                    <el-input v-model="searchInput" :placeholder="t('influencer.searchPlaceholder')" clearable
                        @keyup.enter="handleSearch" @clear="handleClear" class="search-input">
                        <template #prefix>
                            <el-icon>
                                <Search />
                            </el-icon>
                        </template>
                    </el-input>
                    <el-tag v-for="(tag, index) in searchTags" :key="index" closable class="search-tag"
                        @close="removeSearchTag(index)">
                        {{ tag }}
                    </el-tag>
                </div>
                <div class="search-right">
                    <el-button type="primary" @click="handleAdd">
                        <el-icon>
                            <Plus />
                        </el-icon>
                        {{ t('video.addVideo') }}
                    </el-button>
                    <el-button type="info" @click="showMetrics">
                        <el-icon>
                            <DataLine />
                        </el-icon>
                        Êü•ÁúãÊåáÊ†á
                    </el-button>
                </div>
            </div>

            <el-table v-loading="influencerStore.isVideoLoading" :data="filteredData" height="650" fixed border
                style="width: 100%" :default-sort="{ prop: 'parentId', order: 'descending' }"
                :span-method="handleSpanMethod" :row-class-name="tableRowClassName" element-loading-text="Loading..."
                element-loading-background="rgba(197, 197, 197, 0.562)" v-el-table-infinite-scroll="handleTableScroll"
                :infinite-scroll-distance="50" :infinite-scroll-delay="200">
                <!-- IDÂàó -->
                <el-table-column prop="parentId" label="ID" width="80" sortable fixed="left" />
                <!-- Á∫¢‰∫∫ÂêçÁß∞Âàó -->
                <el-table-column prop="Á∫¢‰∫∫ÂêçÁß∞" label="Á∫¢‰∫∫ÂêçÁß∞" width="200" fixed="left">
                    <template #default="scope">
                        <span v-html="highlightText(scope.row.Á∫¢‰∫∫ÂêçÁß∞ || scope.row.Á∫¢‰∫∫ÂÖ®Áß∞)"></span>
                    </template>
                </el-table-column>
                <!-- ÂÖ∂‰ªñÂàó -->
                <el-table-column
                    v-for="column in displayColumns.filter(col => !['parentId', 'Á∫¢‰∫∫ÂêçÁß∞'].includes(col.prop))"
                    :key="column.prop" v-bind="column" resizable @header-dragend="handleHeaderDragend">
                    <template #header="{ column }">
                        <div class="draggable-header">
                            <el-icon class="drag-handle">
                                <Operation />
                            </el-icon>
                            <span class="column-title">{{ column.label }}</span>
                        </div>
                    </template>
                    <template #default="scope">
                        <template v-if="column.prop === 'Âπ≥Âè∞'">
                            <a v-if="isValidURL(scope.row.ËßÜÈ¢ëÈìæÊé•)" :href="scope.row.ËßÜÈ¢ëÈìæÊé•" target="_blank"
                                rel="noopener noreferrer">
                                <el-tag :type="getPlatformTagType(scope.row.Âπ≥Âè∞)" effect="dark" class="tag platform-tag">
                                    <span class="platform-icon">{{ getPlatformIcon(scope.row.Âπ≥Âè∞) }}</span>
                                    <span class="platform-text">{{ scope.row.Âπ≥Âè∞ }}</span>
                                </el-tag>
                            </a>
                            <el-tag v-else :type="getPlatformTagType(scope.row.platform)" effect="dark"
                                class="tag platform-tag">
                                <span class="platform-icon">{{ getPlatformIcon(scope.row.platform) }}</span>
                                <span class="platform-text">{{ scope.row.platform }}</span>
                            </el-tag>
                        </template>
                        <template v-else-if="column.prop === 'Á±ªÂûã'">
                            <a v-if="isValidURL(scope.row.ËßÜÈ¢ëÈìæÊé•)" :href="scope.row.ËßÜÈ¢ëÈìæÊé•" target="_blank"
                                rel="noopener noreferrer">
                                <el-tag :type="getTypeTagType(scope.row.Á±ªÂûã)" effect="light" class="type-tag">
                                    {{ scope.row.Á±ªÂûã }}
                                </el-tag>
                            </a>
                            <el-tag v-else :type="getTypeTagType(scope.row.Á±ªÂûã)" effect="light" class="type-tag">
                                {{ scope.row.Á±ªÂûã }}
                            </el-tag>
                        </template>
                        <template v-else-if="column.prop === 'Áâ©ÊµÅËøõÂ∫¶'">
                            <div class="logistics-container">
                                <template v-if="scope.row.Áâ©ÊµÅÂçïÂè∑">
                                    <el-tooltip placement="top" :show-after="200" :effect="isDark ? 'dark' : 'light'"
                                        :popper-class="[isDark ? 'dark-tooltip' : 'light-tooltip']">
                                        <template #content>
                                            <div v-loading="logisticsLoading[scope.row.id]" class="logistics-details">
                                                <template v-if="scope.row.Áâ©ÊµÅÂçïÂè∑">
                                                    <div v-for="(status, index) in trackingInfo" :key="index"
                                                        class="logistics-item">
                                                        <div class="logistics-item-content">
                                                            <span class="logistics-number">{{ status.number }}</span>
                                                            <el-tag size="small"
                                                                :type="getLogisticsTagType(status.status)"
                                                                effect="light">
                                                                {{ getLogisticsIcon(status.status) }}
                                                                {{ status.status }}
                                                            </el-tag>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div v-else class="no-logistics">ÊöÇÊó†Áâ©ÊµÅ‰ø°ÊÅØ</div>
                                            </div>
                                        </template>
                                        <div class="logistics-display"
                                            @mouseenter="handleLogisticsHover(parseTrackingNumbers(scope.row.Áâ©ÊµÅÂçïÂè∑), scope.row.id)">
                                            <el-tag effect="light" class="logistics-tag">
                                                <span class="logistics-icon">üì¶</span>
                                                <span v-if="getTrackingNumbersCount(scope.row.Áâ©ÊµÅÂçïÂè∑) > 0"
                                                    class="logistics-badge">
                                                    {{ getTrackingNumbersCount(scope.row.Áâ©ÊµÅÂçïÂè∑) }}
                                                </span>
                                            </el-tag>
                                        </div>
                                    </el-tooltip>
                                </template>
                                <template v-else>
                                    <div class="logistics-display">
                                        <el-tag effect="light" class="logistics-tag">
                                            <span class="logistics-icon">üì¶</span>
                                        </el-tag>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template v-else-if="column.prop === 'Á∫¢‰∫∫ÂêçÁß∞'">
                            <span v-html="highlightText(scope.row.Á∫¢‰∫∫ÂêçÁß∞ || scope.row.Á∫¢‰∫∫ÂÖ®Áß∞)"></span>
                        </template>
                        <template v-else-if="column.prop === 'Âêà‰ΩúËøõÂ∫¶'">
                            <el-tag :type="getProgressTagType(scope.row.Âêà‰ΩúËøõÂ∫¶)" effect="dark">
                                {{ scope.row.Âêà‰ΩúËøõÂ∫¶ }}
                            </el-tag>
                        </template>
                        <template v-else-if="column.prop === 'ÂèëÂ∏ÉÊó∂Èó¥'">
                            <el-tooltip :content="getTimeAgo(scope.row.ÂèëÂ∏ÉÊó∂Èó¥)" placement="top">
                                <div class="time-wrapper">
                                    <span class="publish-time">{{ formatDateTime(scope.row.ÂèëÂ∏ÉÊó∂Èó¥) }}</span>
                                    <span class="time-ago-badge">{{ getShortTimeAgo(scope.row.ÂèëÂ∏ÉÊó∂Èó¥) }}</span>
                                </div>
                            </el-tooltip>
                        </template>
                        <template v-else>
                            <span v-html="highlightText(String(scope.row[column.prop] || ''))"></span>
                        </template>
                    </template>
                </el-table-column>

                <!-- Êìç‰ΩúÂàó -->
                <el-table-column fixed="right" label="Êìç‰Ωú" width="150">
                    <template #default="scope">
                        <el-row :gutter="10">
                            <el-col :span="12">
                                <el-tooltip content="Êõ¥Êñ∞" placement="top">
                                    <el-button type="primary" size="small" @click="handleEdit(scope.row)">
                                        Êõ¥Êñ∞
                                    </el-button>
                                </el-tooltip>
                            </el-col>
                            <el-col :span="12">
                                <el-tooltip content="Âà†Èô§" placement="top">
                                    <el-button type="danger" size="small" @click="handleDelete(scope.row)">
                                        Âà†Èô§
                                    </el-button>
                                </el-tooltip>
                            </el-col>
                        </el-row>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>

        <!-- ÊåáÊ†áÁªÑ‰ª∂ -->
        <MetricsList v-model="metricsVisible" />
    </div>
</template>

<script setup lang="ts">
import { useInfluencerStore } from '@/store/useInfluencerStore'
import { computed, nextTick, onBeforeUnmount, onMounted, ref } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import UpdateVideo from './updateVideo.vue'
import { DataLine, Operation, Plus, Search } from '@element-plus/icons-vue'
import AddVideo from './addVideo.vue'
import { useI18n } from 'vue-i18n'
import Sortable from 'sortablejs'
import MetricsList from '@/components/business/influencer/metrics_list.vue'
import { useDark } from '@vueuse/core'

// ÂÆö‰πâÁâ©ÊµÅÈ°πÊé•Âè£
interface LogisticsItem {
    number: string;
    status: string;

}

// Êâ©Â±ï VideoData Êé•Âè£
interface VideoData {
    id: number;
    parentId: number;
    Á∫¢‰∫∫ÂêçÁß∞?: string;
    Á∫¢‰∫∫ÂÖ®Áß∞?: string;
    ÂìÅÁâå?: string;
    È°πÁõÆ?: string;
    Âπ≥Âè∞?: string;
    Á±ªÂûã?: string;
    ÂèëÂ∏ÉÊó∂Èó¥?: string;
    Áâ©ÊµÅËøõÂ∫¶?: string;
    Âêà‰ΩúËøõÂ∫¶?: string;
    Áâ©ÊµÅÈìæÊé•?: Array<LogisticsItem>;
    ËßÜÈ¢ëÈìæÊé•?: string;
    Ë¥üË¥£‰∫∫?: string;
    Ëä±Ë¥π?: number;
    Â∏ÅÁßç?: string;
    È¢Ñ‰º∞ËßÇÁúãÈáè?: number;
    È¢Ñ‰º∞‰∏äÁ∫øÊó∂Èó¥?: string;
    Áâ©ÊµÅÂçïÂè∑?: string;
    products?: Array<{
        ÂìÅÁâå: string;
        È°πÁõÆ: string;
        ‰∫ßÂìÅ: string;
    }>;
    [key: string]: any; // Ê∑ªÂä†Á¥¢ÂºïÁ≠æÂêç‰ª•ÊîØÊåÅÂä®ÊÄÅÂ±ûÊÄßËÆøÈóÆ
}

// Ê∑ªÂä†Á±ªÂûãÂÆö‰πâ
type SearchableField = keyof Pick<VideoData,
    'parentId' | 'Ë¥üË¥£‰∫∫' | 'Á∫¢‰∫∫ÂêçÁß∞' | 'Âêà‰ΩúËøõÂ∫¶' | 'Áâ©ÊµÅËøõÂ∫¶' |
    'ÂìÅÁâå' | 'È°πÁõÆ' | '‰∫ßÂìÅ' | 'Âπ≥Âè∞' | 'Á±ªÂûã' | 'Ëä±Ë¥π' |
    'È¢Ñ‰º∞ËßÇÁúãÈáè' | 'È¢Ñ‰º∞‰∏äÁ∫øÊó∂Èó¥' | 'Â∏ÅÁßç'
>;

// ‰øÆÊîπÊêúÁ¥¢Â≠óÊÆµÈÖçÁΩÆ
const searchableFields: SearchableField[] = [
    'parentId', 'Ë¥üË¥£‰∫∫', 'Á∫¢‰∫∫ÂêçÁß∞', 'Âêà‰ΩúËøõÂ∫¶', 'Áâ©ÊµÅËøõÂ∫¶',
    'ÂìÅÁâå', 'È°πÁõÆ', '‰∫ßÂìÅ', 'Âπ≥Âè∞', 'Á±ªÂûã', 'Ëä±Ë¥π',
    'È¢Ñ‰º∞ËßÇÁúãÈáè', 'È¢Ñ‰º∞‰∏äÁ∫øÊó∂Èó¥', 'Â∏ÅÁßç'
];

const { t } = useI18n()
const influencerStore = useInfluencerStore()
const editDrawerVisible = ref(false)
const addDrawerVisible = ref(false)
const currentRow = ref<VideoData | null>(null)
const currentPage = ref(1)
const pageSize = ref(20)
const displayData = ref<VideoData[]>([])
const isDark = useDark()
const trackingInfo = ref<LogisticsItem[]>([])


// influencerStore.isInfluencerLoading.value
// ÂÆö‰πâË°®Ê†ºÂàóÈÖçÁΩÆ
const tableColumns = [
    { prop: 'parentId', label: 'ID', width: 80, sortable: true, fixed: 'left' },
    { prop: 'Á∫¢‰∫∫ÂêçÁß∞', label: 'Á∫¢‰∫∫ÂêçÁß∞', width: 200, fixed: 'left' },
    { prop: 'Ë¥üË¥£‰∫∫', label: 'Ë¥üË¥£‰∫∫', width: 100 },
    { prop: 'Âêà‰ΩúËøõÂ∫¶', label: 'Âêà‰ΩúËøõÂ∫¶', width: 120 },
    { prop: 'Áâ©ÊµÅËøõÂ∫¶', label: 'Áâ©ÊµÅËøõÂ∫¶', width: 120 },
    { prop: 'ÂìÅÁâå', label: 'ÂìÅÁâå', width: 100 },
    { prop: 'È°πÁõÆ', label: 'È°πÁõÆ', width: 200 },
    { prop: '‰∫ßÂìÅ', label: '‰∫ßÂìÅ', width: 200 },
    { prop: 'Âπ≥Âè∞', label: 'Âπ≥Âè∞', width: 160 },
    { prop: 'Á±ªÂûã', label: 'Á±ªÂûã', width: 140 },
    { prop: 'ÂèëÂ∏ÉÊó∂Èó¥', label: 'ÂèëÂ∏ÉÊó∂Èó¥', width: 220, sortable: true },
    { prop: 'Êí≠ÊîæÈáè', label: 'Êí≠ÊîæÈáè', width: 100, sortable: true },
    { prop: 'ÁÇπËµûÊï∞', label: 'ÁÇπËµûÊï∞', width: 100, sortable: true },
    { prop: 'ËØÑËÆ∫Êï∞', label: 'ËØÑËÆ∫Êï∞', width: 100, sortable: true },
    { prop: 'Êî∂ËóèÊï∞', label: 'Êî∂ËóèÊï∞', width: 100, sortable: true },
    { prop: 'ËΩ¨ÂèëÊï∞', label: 'ËΩ¨ÂèëÊï∞', width: 100, sortable: true },
    { prop: 'ÂèÇ‰∏éÁéá', label: 'ÂèÇ‰∏éÁéá', width: 100, sortable: true },
    { prop: 'Ëä±Ë¥π', label: 'Ëä±Ë¥π', width: 100 },
    { prop: 'È¢Ñ‰º∞ËßÇÁúãÈáè', label: 'È¢Ñ‰º∞ËßÇÁúãÈáè', width: 120 },
    { prop: 'È¢Ñ‰º∞‰∏äÁ∫øÊó∂Èó¥', label: 'È¢Ñ‰º∞‰∏äÁ∫øÊó∂Èó¥', width: 120 },
    { prop: 'Â∏ÅÁßç', label: 'Â∏ÅÁßç', width: 100 }
]

// Áî®‰∫éÊòæÁ§∫ÁöÑÂàóÈ°∫Â∫è
const displayColumns = ref([...tableColumns])

const searchInput = ref('')
const searchTags = ref<string[]>([])

// Ê∑ªÂä† searchKeywords ËÆ°ÁÆóÂ±ûÊÄß
const searchKeywords = computed(() => {
    const keywords: string[] = [...searchTags.value]
    if (searchInput.value.trim()) {
        keywords.push(searchInput.value.trim())
    }
    return keywords
})

// Ê∑ªÂä† searchCache ËÆ°ÁÆóÂ±ûÊÄß
const searchCache = ref(new Map())

// Ê∑ªÂä† filteredData ËÆ°ÁÆóÂ±ûÊÄß
const filteredData = computed<VideoData[]>(() => {
    return displayData.value
})

// ËÆ°ÁÆóÂ§ÑÁêÜÂêéÁöÑÊï∞ÊçÆ
const processedData = computed<VideoData[]>(() => {
    return displayData.value
})

// Ê∑ªÂä†Áä∂ÊÄÅ‰øùÊåÅÁõ∏ÂÖ≥ÁöÑÂèòÈáè
const currentSearchState = ref({
    keywords: [] as string[],
    currentData: [] as VideoData[],
    scrollPosition: 0
});

// ‰øÆÊîπhandleSearchÊñπÊ≥ï
const handleSearch = () => {
    if (!searchInput.value.trim()) {
        displayData.value = influencerStore.videoList.slice(0, pageSize.value)
        return
    }

    const searchText = searchInput.value.trim()
    searchTags.value.push(searchText)
    searchInput.value = ''

    const keywords = searchKeywords.value
    const cacheKey = keywords.sort().join(',')

    if (searchCache.value.has(cacheKey)) {
        displayData.value = searchCache.value.get(cacheKey)
        return
    }

    const results = influencerStore.videoList.filter((row: VideoData) => {
        return keywords.every(keyword => {
            if (!keyword) return true
            const searchText = keyword.toLowerCase()
            return searchableFields.some(field => {
                const fieldValue = String(row[field] || '').toLowerCase()
                return fieldValue.includes(searchText)
            })
        })
    })

    searchCache.value.set(cacheKey, results)
    displayData.value = results
}

// ‰øÆÊîπhandleTableScrollÊñπÊ≥ï
const handleTableScroll = async () => {
    if (influencerStore.isVideoLoading) return;

    influencerStore.isVideoLoading = true;

    try {
        // Âà§Êñ≠ÊòØÂê¶Â§Ñ‰∫éÊêúÁ¥¢Áä∂ÊÄÅ
        const isSearching = searchTags.value.length > 0;
        // Ëé∑ÂèñÊ∫êÊï∞ÊçÆ
        const sourceList = isSearching
            ? displayData.value  // Â¶ÇÊûúÂú®ÊêúÁ¥¢Áä∂ÊÄÅÔºå‰ΩøÁî®ÂΩìÂâçÊòæÁ§∫ÁöÑÊï∞ÊçÆ
            : influencerStore.videoList;

        const start = displayData.value.length;
        const end = start + pageSize.value;

        if (start >= sourceList.length) {
            influencerStore.isVideoLoading = false;
            return;
        }

        const newData = sourceList.slice(start, end);
        displayData.value = [...displayData.value, ...newData];
    } catch (error) {
        console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
        ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•');
    } finally {
        setTimeout(() => {
            influencerStore.isVideoLoading = false;
        }, 300);
    }
};

// ÂàùÂßãÂåñÂä†ËΩΩ
onMounted(async () => {
    currentPage.value = 1
    displayData.value = []
    await influencerStore.getVideoList()
    displayData.value = influencerStore.videoList.slice(0, pageSize.value)
    initSortable()
})

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
onBeforeUnmount(() => {
    displayData.value = []
    currentPage.value = 1
    influencerStore.videoList = []
    clearSearchCache()
})

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÂêàÂπ∂
const handleSpanMethod = ({ row, column, rowIndex }: { row: VideoData; column: { property: string }; rowIndex: number }) => {
    if (!row.parentId) return [1, 1]

    // ÁâπÊÆäÂ§ÑÁêÜÂìÅÁâå„ÄÅÈ°πÁõÆ„ÄÅ‰∫ßÂìÅÁöÑÂêàÂπ∂ÈÄªËæë
    if (column.property === 'ÂìÅÁâå' || column.property === 'È°πÁõÆ' || column.property === '‰∫ßÂìÅ') {
        const prevRow = filteredData.value[rowIndex - 1]
        let span = 1

        // Â¶ÇÊûúÊòØÂìÅÁâåÂàó
        if (column.property === 'ÂìÅÁâå') {
            // ‰∏éÂâç‰∏ÄË°åÊØîËæÉÂìÅÁâå
            if (prevRow && prevRow.parentId === row.parentId && prevRow.ÂìÅÁâå === row.ÂìÅÁâå) {
                return [0, 1]
            }
            // ËÆ°ÁÆóÂêéÁª≠Áõ∏ÂêåÂìÅÁâåÁöÑË°åÊï∞
            for (let i = rowIndex + 1; i < filteredData.value.length; i++) {
                const nextRow = filteredData.value[i]
                if (nextRow.parentId === row.parentId && nextRow.ÂìÅÁâå === row.ÂìÅÁâå) {
                    span++
                } else {
                    break
                }
            }
        }
        // Â¶ÇÊûúÊòØÈ°πÁõÆÂàó
        else if (column.property === 'È°πÁõÆ') {
            // ‰∏éÂâç‰∏ÄË°åÊØîËæÉÂìÅÁâåÂíåÈ°πÁõÆ
            if (prevRow && prevRow.parentId === row.parentId &&
                prevRow.ÂìÅÁâå === row.ÂìÅÁâå && prevRow.È°πÁõÆ === row.È°πÁõÆ) {
                return [0, 1]
            }
            // ËÆ°ÁÆóÂêéÁª≠Áõ∏ÂêåÂìÅÁâåÂíåÈ°πÁõÆÁöÑË°åÊï∞
            for (let i = rowIndex + 1; i < filteredData.value.length; i++) {
                const nextRow = filteredData.value[i]
                if (nextRow.parentId === row.parentId &&
                    nextRow.ÂìÅÁâå === row.ÂìÅÁâå && nextRow.È°πÁõÆ === row.È°πÁõÆ) {
                    span++
                } else {
                    break
                }
            }
        }
        // ‰∫ßÂìÅÂàó‰∏çÂêàÂπ∂
        else if (column.property === '‰∫ßÂìÅ') {
            return [1, 1]
        }

        return [span, 1]
    }

    // ÂÖ∂‰ªñÂàóÁöÑÂêàÂπ∂ÈÄªËæë‰øùÊåÅ‰∏çÂèò
    const spanMap = new Map()
    filteredData.value.forEach((item, index) => {
        if (!spanMap.has(item.parentId)) {
            spanMap.set(item.parentId, {
                start: index,
                count: 1,
                value: item[column.property]
            })
        } else {
            const info = spanMap.get(item.parentId)
            if (info.value === item[column.property]) {
                info.count++
            } else {
                info.count = 1
                info.start = index
                info.value = item[column.property]
            }
        }
    })

    const prevRow = filteredData.value[rowIndex - 1]
    if (prevRow && prevRow.parentId === row.parentId &&
        prevRow[column.property] === row[column.property]) {
        return [0, 0]
    }

    let span = 1
    for (let i = rowIndex + 1; i < filteredData.value.length; i++) {
        const nextRow = filteredData.value[i]
        if (nextRow.parentId === row.parentId &&
            nextRow[column.property] === row[column.property]) {
            span++
        } else {
            break
        }
    }
    return [span, 1]
}

// Ë°®Ê†ºË°åÊ†∑Âºè
const tableRowClassName = ({ row }: { row: VideoData }) => {
    if (!row.parentId) return ''
    return row.parentId % 2 === 0 ? 'even-row' : 'odd-row'
}

// ‰øÆÊîπÈ´ò‰∫ÆÊñáÊú¨ÊñπÊ≥ï
const highlightText = (text: string): string => {
    if (!text) return ''
    let result = text
    searchKeywords.value.forEach(keyword => {
        if (!keyword) return
        // ËΩ¨‰πâÊ≠£ÂàôË°®ËææÂºè‰∏≠ÁöÑÁâπÊÆäÂ≠óÁ¨¶
        const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
        // ‰ΩøÁî®Èõ∂ÂÆΩÊñ≠Ë®ÄÁ°Æ‰øù‰∏ç‰ºöÂåπÈÖçÂà∞Â∑≤ÁªèÈ´ò‰∫ÆÁöÑÊñáÊú¨
        const reg = new RegExp(`(?<!<[^>]*)(${escapedKeyword})(?![^<]*>)`, 'gi')
        result = result.replace(reg, '<span class="highlight-text">$1</span>')
    })
    return result
}

// Êõ¥Êñ∞ÊàêÂäüÂõûË∞É
const handleUpdateSuccess = async () => {
    try {
        // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
        currentSearchState.value = {
            keywords: [...searchTags.value],
            currentData: [...displayData.value],
            scrollPosition: document.querySelector('.el-table__body-wrapper')?.scrollTop || 0
        };

        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
        await influencerStore.getVideoList();

        // Â¶ÇÊûúÊúâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºåÂ∫îÁî®Áé∞ÊúâÁöÑÁ≠õÈÄâÊù°‰ª∂
        if (currentSearchState.value.keywords.length > 0) {
            searchTags.value = [...currentSearchState.value.keywords];
            const results = influencerStore.videoList.filter((row: VideoData) => {
                return searchTags.value.every(keyword => {
                    if (!keyword) return true;
                    const searchText = keyword.toLowerCase();
                    return searchableFields.some(field => {
                        const fieldValue = String(row[field] || '').toLowerCase();
                        return fieldValue.includes(searchText);
                    });
                });
            });
            displayData.value = results;
        } else {
            // Â¶ÇÊûúÊ≤°ÊúâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºå‰øùÊåÅÂΩìÂâçÊòæÁ§∫ÁöÑÊï∞ÊçÆÈáè
            const currentLength = currentSearchState.value.currentData.length;
            displayData.value = influencerStore.videoList.slice(0, currentLength);
        }

        // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
        nextTick(() => {
            const tableBody = document.querySelector('.el-table__body-wrapper');
            if (tableBody) {
                tableBody.scrollTop = currentSearchState.value.scrollPosition;
            }
        });

        ElMessage.success(t('message.updateSuccess'));
    } catch (error) {
        console.error('Êõ¥Êñ∞ÂàóË°®Â§±Ë¥•:', error);
        ElMessage.error(t('message.updateFailed'));
    }
};

// ‰øÆÊîπÁªÑ‰ª∂Áä∂ÊÄÅÂèòÈáè
const isAdd = ref(false)
const updateDrawerVisible = ref(false)

// Â§ÑÁêÜÁºñËæë
const handleEdit = (row: VideoData) => {
    currentRow.value = { ...row };
    updateDrawerVisible.value = true;
}

// Â§ÑÁêÜÊñ∞Â¢û
const handleAdd = () => {
    isAdd.value = true;
}

// Â§ÑÁêÜÊäΩÂ±âÂÖ≥Èó≠
const handleDrawerClose = () => {
    isAdd.value = false;
    updateDrawerVisible.value = false;
    currentRow.value = null;
}

// ‰øÆÊîπ Sortable ÁöÑÁ±ªÂûãÂÆö‰πâ
interface SortableEvent {
    oldIndex?: number;
    newIndex?: number;
}

// ‰øÆÊîπ initSortable ÊñπÊ≥ï
const initSortable = () => {
    const maxRetries = 5;
    let retryCount = 0;

    const tryInit = () => {
        const el = document.querySelector('.el-table__header-wrapper .el-table__header thead tr');
        if (!el || el.clientWidth === 0) {
            if (retryCount < maxRetries) {
                retryCount++;
                setTimeout(tryInit, 200); // 200ms ÂêéÈáçËØï
                return;
            }
            console.warn('ÂàùÂßãÂåñË°®Ê†ºÂ∏ÉÂ±ÄÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Ë°®Ê†ºÊòØÂê¶Ê≠£Á°ÆÊ∏≤Êüì');
            return;
        }

        // ÊÅ¢Â§çÂàóÂÆΩÂ∫¶
        const savedWidths = localStorage.getItem('tableColumnWidths');
        if (savedWidths) {
            try {
                const widths = JSON.parse(savedWidths);
                displayColumns.value = displayColumns.value.map(col => ({
                    ...col,
                    width: widths[col.prop] || col.width
                }));
            } catch (e) {
                console.error('Error parsing saved column widths:', e);
            }
        }

        // ÂàùÂßãÂåñÊãñÊãΩÊéíÂ∫è
        Sortable.create(el as HTMLElement, {
            handle: '.drag-handle',
            animation: 150,
            onEnd(event: SortableEvent) {
                const { oldIndex, newIndex } = event;
                if (typeof oldIndex === 'number' && typeof newIndex === 'number' && oldIndex !== newIndex) {
                    const columnsCopy = [...displayColumns.value];
                    const [removed] = columnsCopy.splice(oldIndex, 1);
                    columnsCopy.splice(newIndex, 0, removed);
                    displayColumns.value = columnsCopy;
                    localStorage.setItem('tableColumnsOrder', JSON.stringify(columnsCopy));
                }
            }
        });

        // ÁõëÂê¨ÂàóÂÆΩÂ∫¶ÂèòÂåñ
        const table = document.querySelector('.el-table');
        if (table) {
            const observer = new MutationObserver(() => {
                const headers = document.querySelectorAll('.el-table__header-wrapper th');
                const widths: { [key: string]: number } = {};
                headers.forEach((header: Element) => {
                    const prop = header.getAttribute('data-column-id');
                    if (prop) {
                        const width = (header as HTMLElement).style.width;
                        if (width) {
                            widths[prop] = parseInt(width);
                        }
                    }
                });
                if (Object.keys(widths).length > 0) {
                    localStorage.setItem('tableColumnWidths', JSON.stringify(widths));
                }
            });

            observer.observe(table, {
                attributes: true,
                subtree: true,
                attributeFilter: ['style']
            });
        }
    };

    // ÂºÄÂßãÂ∞ùËØïÂàùÂßãÂåñ
    tryInit();
};


// Ê∑ªÂä†Áâ©ÊµÅÁä∂ÊÄÅÊ†áÁ≠æÁ±ªÂûãËé∑ÂèñÂáΩÊï∞
const getLogisticsTagType = (status: string): string => {
    switch (status) {
        case 'ÊàêÂäüÁ≠æÊî∂':
            return 'success';
        case 'ËøêËæìÈÄî‰∏≠':
            return 'warning';
        case 'ÂæÖÂèëË¥ß':
            return 'info';
        case 'ÂºÇÂ∏∏':
            return 'danger';
        default:
            return 'info';
    }
}


// Âú®ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÊÅ¢Â§ç‰øùÂ≠òÁöÑÂàóÈ°∫Â∫è
onMounted(() => {
    const savedOrder = localStorage.getItem('tableColumnsOrder');
    if (savedOrder) {
        try {
            displayColumns.value = JSON.parse(savedOrder);
        } catch (e) {
            console.error('Error parsing saved column order:', e);
        }
    }
    initSortable();
});

const getProgressTagType = (progress: string): string => {
    if (!progress) return 'info'
    switch (progress) {
        case 'Âêà‰ΩúÂÆåÊàê':
            return 'success'
        case 'ËøõË°å‰∏≠':
            return 'warning'
        case 'ÂæÖÂºÄÂßã':
            return 'info'
        case 'Âêà‰ΩúÂ§±Ë¥•':
            return 'danger'
        default:
            return 'info'
    }
}

const getTypeTagType = (type: string) => {
    switch (type) {
        case 'ËßÜÈ¢ë':
            return 'primary'
        case 'Áü≠ËßÜÈ¢ë':
            return 'success'
        case 'ÂõæÁâá':
            return 'warning'
        default:
            return 'info'
    }
}

interface PlatformType {
    [key: string]: string;
}

// È™åËØÅURLÁöÑÂáΩÊï∞
const isValidURL = (url: string): boolean => {
    if (!url) return false
    try {
        new URL(url)
        return true
    } catch {
        return false
    }
}

const getPlatformTagType = (platform: string | undefined): string => {
    if (!platform) return 'info'
    const typeMap: PlatformType = {
        'youtube': 'danger',
        'instagram': 'warning',
        'tiktok': 'success',
        'x': 'info',
        'facebook': 'primary',
        'twitch': 'purple',
        'linkedin': 'info',
    }
    return typeMap[platform.toLowerCase()] || 'info'
}

const getPlatformIcon = (platform: string | undefined): string => {
    if (!platform) return 'üåê'
    const iconMap: PlatformType = {
        'youtube': 'üì∫',
        'instagram': 'üì∑',
        'tiktok': 'üéµ',
        'x': 'üê¶',
        'facebook': 'üë•',
        'twitch': 'üéÆ',
        'linkedin': '',
    }
    return iconMap[platform.toLowerCase()] || 'üåê'
}

// Âú®scriptÈÉ®ÂàÜÊ∑ªÂä†Ê†ºÂºèÂåñÂáΩÊï∞
const formatDateTime = (dateTimeStr: string): string => {
    if (!dateTimeStr) return ''
    try {
        const date = new Date(dateTimeStr)
        const year = date.getFullYear()
        const month = String(date.getMonth() + 1).padStart(2, '0')
        const day = String(date.getDate()).padStart(2, '0')
        const hours = String(date.getHours()).padStart(2, '0')
        const minutes = String(date.getMinutes()).padStart(2, '0')
        const seconds = String(date.getSeconds()).padStart(2, '0')
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
    } catch {
        return dateTimeStr
    }
}

// Ëé∑ÂèñÊó∂Èó¥Èó¥ÈöîÔºàËØ¶ÁªÜÁâàÊú¨Ôºâ
const getTimeAgo = (dateTimeStr: string): string => {
    if (!dateTimeStr) return ''
    try {
        const date = new Date(dateTimeStr)
        const now = new Date()
        const diff = now.getTime() - date.getTime()
        const days = Math.floor(diff / (1000 * 60 * 60 * 24))
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))

        if (days > 0) {
            return `Âú®${days}Â§©${hours}Â∞èÊó∂ÂâçÂèëÂ∏É`
        } else if (hours > 0) {
            return `Âú®${hours}Â∞èÊó∂${minutes}ÂàÜÈíüÂâçÂèëÂ∏É`
        } else if (minutes > 0) {
            return `Âú®${minutes}ÂàÜÈíüÂâçÂèëÂ∏É`
        } else {
            return 'Âú®ÂàöÂàöÂèëÂ∏É'
        }
    } catch {
        return ''
    }
}

// Ëé∑ÂèñÊó∂Èó¥Èó¥ÈöîÔºàÁÆÄÁü≠ÁâàÊú¨Ôºâ
const getShortTimeAgo = (dateTimeStr: string): string => {
    if (!dateTimeStr) return ''
    try {
        const date = new Date(dateTimeStr)
        const now = new Date()
        const diff = now.getTime() - date.getTime()
        const days = Math.floor(diff / (1000 * 60 * 60 * 24))
        if (days > 0) {
            return days + 'Â§©Ââç'
        }
        const hours = Math.floor(diff / (1000 * 60 * 60))
        if (hours > 0) {
            return hours + 'Â∞èÊó∂Ââç'
        }
        const minutes = Math.floor(diff / (1000 * 60))
        if (minutes > 0) {
            return minutes + 'ÂàÜÈíüÂâç'
        }
        return 'ÂàöÂàö'
    } catch {
        return ''
    }
}

// ‰øÆÊîπremoveSearchTagÊñπÊ≥ï
const removeSearchTag = (index: number) => {
    searchTags.value.splice(index, 1)
    clearSearchCache()

    if (searchTags.value.length === 0) {
        displayData.value = influencerStore.videoList.slice(0, pageSize.value)
        return
    }

    const keywords = searchKeywords.value
    const cacheKey = keywords.sort().join(',')

    if (searchCache.value.has(cacheKey)) {
        displayData.value = searchCache.value.get(cacheKey)
        return
    }

    const results = influencerStore.videoList.filter((row: VideoData) => {
        return keywords.every(keyword => {
            if (!keyword) return true
            const searchText = keyword.toLowerCase()
            return searchableFields.some(field => {
                const fieldValue = String(row[field] || '').toLowerCase()
                return fieldValue.includes(searchText)
            })
        })
    })

    searchCache.value.set(cacheKey, results)
    displayData.value = results
}

// ‰øÆÊîπhandleClearÊñπÊ≥ï
const handleClear = () => {
    searchInput.value = ''
    searchTags.value = []
    clearSearchCache()
    displayData.value = influencerStore.videoList.slice(0, pageSize.value)
}

// Ê∏ÖÁêÜÁºìÂ≠òÁöÑÊñπÊ≥ï
const clearSearchCache = () => {
    searchCache.value.clear()
}

// Ê∑ªÂä†Â§ÑÁêÜÂàóÂÆΩÂ∫¶ÂèòÂåñÁöÑÊñπÊ≥ï
const handleHeaderDragend = (newWidth: number, oldWidth: number, column: any) => {
    // ‰øùÂ≠òÊñ∞ÁöÑÂàóÂÆΩÂ∫¶
    const columnWidths = JSON.parse(localStorage.getItem('tableColumnWidths') || '{}')
    columnWidths[column.property] = newWidth
    localStorage.setItem('tableColumnWidths', JSON.stringify(columnWidths))

    // Êõ¥Êñ∞ displayColumns ‰∏≠ÁöÑÂÆΩÂ∫¶
    const index = displayColumns.value.findIndex(col => col.prop === column.property)
    if (index !== -1) {
        displayColumns.value[index] = {
            ...displayColumns.value[index],
            width: newWidth
        }
    }
}

// Êõ¥Êñ∞Áâ©ÊµÅÁä∂ÊÄÅÂõæÊ†áËé∑ÂèñÂáΩÊï∞
const getLogisticsIcon = (status: string): string => {
    switch (status) {
        case 'ÂæÖÂèëË¥ß':
            return 'üì¶';
        case 'ÊàêÂäüÁ≠æÊî∂':
            return '‚úÖ';
        case '‰∫§‰ªò':
            return 'üîÑ';
        default:
            return 'üìã';
    }
};

// Ëé∑Âèñ‰∏ªË¶ÅÊòæÁ§∫ÁöÑÁâ©ÊµÅÁä∂ÊÄÅ
const getMainLogisticsStatus = (row: VideoData): string => {
    if (!row.Áâ©ÊµÅÈìæÊé• || row.Áâ©ÊµÅÈìæÊé•.length === 0) {
        return row.Áâ©ÊµÅËøõÂ∫¶ || 'ÊöÇÊó†Áâ©ÊµÅ';
    }

    const pendingLogistics = row.Áâ©ÊµÅÈìæÊé•.find((item: LogisticsItem) => item.status === 'ÂæÖÂèëË¥ß');
    if (pendingLogistics) {
        return pendingLogistics.status;
    }

    const deliveringLogistics = row.Áâ©ÊµÅÈìæÊé•.find((item: LogisticsItem) => item.status === '‰∫§‰ªò');
    if (deliveringLogistics) {
        return deliveringLogistics.status;
    }

    return row.Áâ©ÊµÅÈìæÊé•[row.Áâ©ÊµÅÈìæÊé•.length - 1].status;
}


// Ëé∑Âèñ‰∏ªË¶ÅÁâ©ÊµÅÁä∂ÊÄÅÁöÑÊ†áÁ≠æÁ±ªÂûã
const getMainLogisticsTagType = (row: VideoData): string => {
    const mainStatus = getMainLogisticsStatus(row);
    return getLogisticsTagType(mainStatus);
}

// Ê†ºÂºèÂåñÁâ©ÊµÅËØ¶ÊÉÖ
const formatLogisticsDetails = (logisticsList: Array<LogisticsItem>): Array<LogisticsItem> => {
    if (!logisticsList) return [];
    return logisticsList.map(line => {
        const [number, status] = line.split(': ').map(s => s.trim());
        return { number, status };
    });
}

// Ê∑ªÂä†ÊåáÊ†áÁõ∏ÂÖ≥ÁöÑÁä∂ÊÄÅ
const metricsVisible = ref(false)

// Ê∑ªÂä†ÊòæÁ§∫ÊåáÊ†áÁöÑÊñπÊ≥ï
const showMetrics = () => {
    metricsVisible.value = true
}

// Â§ÑÁêÜÂà†Èô§
const handleDelete = async (row: VideoData) => {
    try {
        // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
        currentSearchState.value = {
            keywords: [...searchTags.value],
            currentData: [...displayData.value],
            scrollPosition: document.querySelector('.el-table__body-wrapper')?.scrollTop || 0
        };

        const relatedRows = processedData.value.filter(item => item.parentId === row.parentId);
        const ids = relatedRows.map(item => item.id);

        await ElMessageBox.confirm(
            'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∫õËÆ∞ÂΩïÂêóÔºü',
            'Ë≠¶Âëä',
            {
                confirmButtonText: 'Á°ÆÂÆö',
                cancelButtonText: 'ÂèñÊ∂à',
                type: 'warning',
            }
        );

        await influencerStore.deleteVideo(row.parentId);
        ElMessage.success('Âà†Èô§ÊàêÂäü');

        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÂπ∂Â∫îÁî®Á≠õÈÄâ
        await influencerStore.getVideoList();
        if (currentSearchState.value.keywords.length > 0) {
            searchTags.value = [...currentSearchState.value.keywords];
            const results = influencerStore.videoList.filter((row: VideoData) => {
                return searchTags.value.every(keyword => {
                    if (!keyword) return true;
                    const searchText = keyword.toLowerCase();
                    return searchableFields.some(field => {
                        const fieldValue = String(row[field] || '').toLowerCase();
                        return fieldValue.includes(searchText);
                    });
                });
            });
            displayData.value = results;
        } else {
            const currentLength = currentSearchState.value.currentData.length;
            displayData.value = influencerStore.videoList.slice(0, currentLength);
        }

        // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
        nextTick(() => {
            const tableBody = document.querySelector('.el-table__body-wrapper');
            if (tableBody) {
                tableBody.scrollTop = currentSearchState.value.scrollPosition;
            }
        });
    } catch (error) {
        if (error !== 'cancel') {
            ElMessage.error('Âà†Èô§Â§±Ë¥•');
        }
    }
};

const logisticsLoading = ref<{ [key: number]: boolean }>({})

// Ëé∑ÂèñÁâ©ÊµÅÂçïÂè∑Êï∞Èáè
const getTrackingNumbersCount = (trackingUrl: string): number => {
    if (!trackingUrl) return 0;
    const numbers = parseTrackingNumbers(trackingUrl);
    return numbers.length;
}

// Ëß£ÊûêÁâ©ÊµÅÂçïÂè∑
const parseTrackingNumbers = (trackingUrl: string): string[] => {
    if (!trackingUrl) return [];

    try {
        // Â§ÑÁêÜ17trackÁöÑÈìæÊé•Ê†ºÂºè
        if (trackingUrl.includes('17track.net')) {
            const numsMatch = trackingUrl.match(/nums=([^#&]+)/);
            if (numsMatch && numsMatch[1]) {
                return numsMatch[1].split(',').map(num => num.trim());
            }
        }

        // Â§ÑÁêÜÂÖ∂‰ªñÂèØËÉΩÁöÑÊ†ºÂºè
        if (trackingUrl.includes(',')) {
            return trackingUrl.split(',').map(num => num.trim());
        }

        // Â¶ÇÊûúÂè™ÊúâÂçï‰∏™ÂçïÂè∑
        return [trackingUrl.trim()];
    } catch (error) {
        console.error('Ëß£ÊûêÁâ©ÊµÅÂçïÂè∑Â§±Ë¥•:', error);
        return [];
    }
}

// Â§ÑÁêÜÁâ©ÊµÅ‰ø°ÊÅØÊÇ¨ÂÅú
const handleLogisticsHover = async (numbers: any, id: any) => {
    console.log(numbers);
    if (numbers === null) {
        return
    }
    try {
        logisticsLoading[id] = true
        const tracking = await influencerStore.queryTrackingStatus(numbers);
        console.log(tracking);
        trackingInfo.value = tracking;
        console.log(trackingInfo.value);
    } catch (error) {
        console.error('Â§ÑÁêÜÁâ©ÊµÅ‰ø°ÊÅØÊÇ¨ÂÅú ', error);
    } finally {
        logisticsLoading[id] = false
    }
}

</script>

<style scoped>
.video-table {
    width: 100%;
    border-radius: 5px;
}

.video_card {
    margin: 0 auto;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    background: #fff;
    transition: all 0.3s ease;

    &:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    animation: cardFadeIn 0.5s ease-out;
}

@keyframes cardFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Ë°®Ê†ºÊ†∑Âºè‰ºòÂåñ */
:deep(.el-table) {
    border-radius: 4px;
    overflow: hidden;
    transition: all 0.3s ease;
}

:deep(.el-table__row) {
    transition: all 0.2s ease;
    height: 50px;
    line-height: 50px;

    &:hover {
        background-color: #f5f7fa;
        transform: scale(1.001);
    }
}

:deep(.el-table__cell) {
    padding: 8px 0;
}

:deep(.el-table__header-wrapper th) {
    background-color: #f5f7fa;
    font-weight: 600;
    color: #606266;
}

/* ÊªöÂä®Êù°ÁæéÂåñ */
:deep(.el-table__body-wrapper::-webkit-scrollbar) {
    width: 6px;
    height: 6px;
}

:deep(.el-table__body-wrapper::-webkit-scrollbar-thumb) {
    border-radius: 3px;
    background-color: #dcdfe6;

    &:hover {
        background-color: #c0c4cc;
    }
}

:deep(.el-table__body-wrapper::-webkit-scrollbar-track) {
    background-color: #f5f7fa;
}

/* ÊåâÈíÆÊ†∑Âºè */
.el-button {
    padding: 4px 8px;
    margin: 0 4px;
    transition: all 0.3s ease;
}

.el-button--danger:hover {
    transform: scale(1.05);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
html.dark {
    .video_card {
        background: #1f1f1f;
        border-color: #363636;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    :deep(.el-table) {
        background-color: #1f1f1f;
        color: #ffffff;

        td.el-table__cell {
            background-color: #1f1f1f;
            border-bottom: 1px solid #363636;
        }

        th.el-table__cell {
            background-color: #2c2c2c !important;
            border-bottom: 1px solid #363636;
            color: #ffffff;
        }
    }

    :deep(.el-table__row:hover > td) {
        background-color: #363636 !important;
    }

    :deep(.el-table--striped .el-table__row--striped td) {
        background-color: #2c2c2c;
    }
}

/* Ê∑ªÂä†ÊêúÁ¥¢Âå∫ÂüüÊ†∑Âºè */
.search-area {
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
}

.search-left {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    flex: 1;
}

.search-right {
    display: flex;
    align-items: center;
    gap: 12px;
    /* Ê∑ªÂä†ÊåâÈíÆÈó¥Ë∑ù */
}

.search-input {
    width: 300px;
}

.search-tag {
    margin-right: 4px;
    animation: tagFadeIn 0.3s ease-out;
}

@keyframes tagFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
html.dark {
    .search-area {
        :deep(.el-input__inner) {
            background-color: var(--el-bg-color-overlay);
            border-color: var(--el-border-color-light);
        }
    }

    /* ... ÂÖ∂‰ªñÊöóÈªëÊ®°ÂºèÊ†∑Âºè‰øùÊåÅ‰∏çÂèò ... */
}

:deep(.highlight-text) {
    color: var(--el-color-primary);
    font-weight: bold;
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÈ´ò‰∫ÆÊ†∑Âºè */
html.dark :deep(.highlight-text) {
    color: var(--el-color-primary-light-3);
}

:deep(.odd-row) {
    background-color: var(--el-table-row-hover-bg-color);
}

:deep(.even-row) {
    background-color: var(--el-bg-color);
}

/* ‰øÆÊîπÊÇ¨ÂÅúÊ†∑Âºè */
:deep(.el-table__row:hover > td) {
    background-color: var(--el-color-primary-light-9) !important;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
html.dark {
    :deep(.odd-row) {
        background-color: #2a2a2a;
        /* Ê∑±Ëâ≤‰ΩÜÊØîeven-rowÁï•‰∫Æ */
    }

    :deep(.even-row) {
        background-color: #1a1a1a;
        /* Êõ¥Ê∑±ÁöÑËÉåÊôØËâ≤ */
    }

    /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÊÇ¨ÂÅúÊ†∑Âºè */
    :deep(.el-table__row:hover > td) {
        background-color: #363636 !important;
        /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÁöÑÈ¢úËâ≤ */
    }

    /* Á°Æ‰øùË°®Ê†ºËæπÊ°ÜÂú®ÊöóËâ≤Ê®°Âºè‰∏ãÂèØËßÅ */
    :deep(.el-table) {
        --el-table-border-color: #4c4c4c;
        --el-table-header-bg-color: #2c2c2c;
    }

    /* Ë°®Â§¥Ê†∑Âºè */
    :deep(.el-table__header-wrapper th) {
        background-color: #2c2c2c !important;
        border-bottom: 1px solid #4c4c4c;
        color: #ffffff;
    }

    /* ÂçïÂÖÉÊ†ºËæπÊ°Ü */
    :deep(.el-table__cell) {
        border-bottom: 1px solid #363636;
    }
}

/* Êñ∞Â¢ûÊåâÈíÆÂä®ÁîªÊïàÊûú */
.el-button {
    transition: all 0.3s ease;

    &:hover {
        transform: scale(1.05);
    }
}

.draggable-header {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: move;
    width: 100%;
    justify-content: space-between;
}

.column-title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.drag-handle {
    cursor: move;
    padding: 2px;
    border-radius: 4px;
    transition: all 0.2s ease;
    margin-left: auto;

    &:hover {
        background-color: var(--el-color-primary-light-8);
        color: var(--el-color-primary);
    }
}

/* Á°Æ‰øùË°®Â§¥ÂÜÖÂÆπ‰∏çÊç¢Ë°å */
:deep(.el-table__header th) {
    white-space: nowrap;

    .cell {
        display: flex;
        align-items: center;
    }
}

/* Á°Æ‰øùÊéíÂ∫èÂõæÊ†áÂú®Âè≥‰æß */
:deep(.el-table__column-sort-icon) {
    margin-left: auto;
}

/* Ê†áÁ≠æÊ†∑Âºè‰ºòÂåñ */
:deep(.el-tag) {
    border-radius: 4px;
    padding: 2px 8px;
    font-weight: 500;
    transition: all 0.3s ease;

    &:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
}

/* ËøõÂ∫¶Ê†áÁ≠æÁâπÊÆäÊ†∑Âºè */
:deep(.el-tag--success) {
    background-color: rgba(103, 194, 58, 0.1);
    border-color: rgba(103, 194, 58, 0.2);
    color: #67c23a;
}

:deep(.el-tag--warning) {
    background-color: rgba(230, 162, 60, 0.1);
    border-color: rgba(230, 162, 60, 0.2);
    color: #e6a23c;
}

:deep(.el-tag--danger) {
    background-color: rgba(245, 108, 108, 0.1);
    border-color: rgba(245, 108, 108, 0.2);
    color: #f56c6c;
}

:deep(.el-tag--info) {
    background-color: rgba(144, 147, 153, 0.1);
    border-color: rgba(144, 147, 153, 0.2);
    color: #909399;
}

/* Ë°®Â§¥ÊãñÊãΩÊó∂ÁöÑÊ†∑Âºè */
:deep(.sortable-ghost) {
    background-color: var(--el-color-primary-light-9);
    opacity: 0.8;
}

:deep(.sortable-drag) {
    background-color: var(--el-color-primary-light-8);
    opacity: 0.9;
}

/* Âπ≥Âè∞Ê†áÁ≠æÂü∫Á°ÄÊ†∑Âºè */
/* Âπ≥Âè∞Ê†áÁ≠æÂü∫Á°ÄÊ†∑ÂºèÔºà‰øÆÊîπÂêéÔºå‰∏é a.vue ‰øùÊåÅ‰∏ÄËá¥Ôºâ */
.platform-tag {
    padding: 8px 15px;
    font-weight: 600;
    border-radius: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: capitalize;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    min-width: 100px;
    justify-content: center;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}


/* ÂõæÊ†áÊ†∑Âºè */
.platform-icon {
    font-size: 16px;
    line-height: 1;
    flex-shrink: 0;
}

/* ÊñáÊú¨Ê†∑Âºè */
.platform-text {
    font-size: 14px;
    letter-spacing: 0.5px;
    font-weight: 600;
    flex: 1;
    text-align: center;
    display: inline-block;
}

/* Á±ªÂûãÊ†áÁ≠æÊ†∑Âºè */
.type-tag {
    padding: 4px 8px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    /* ‰ΩøÁî®ÂÆåÊï¥ÂÆΩÂ∫¶ */
}

/* Á°Æ‰øùË°®Ê†ºÂçïÂÖÉÊ†ºÂÜÖÂÆπ‰∏ç‰ºöÊ∫¢Âá∫ */
:deep(.el-table__cell) {
    .cell {
        white-space: nowrap;
    }
}

/* ÂèëÂ∏ÉÊó∂Èó¥Ê†∑Âºè */
.publish-time {
    font-family: 'Roboto Mono', monospace;
    color: var(--el-text-color-primary);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
    letter-spacing: 0.5px;
    display: inline-block;
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÂèëÂ∏ÉÊó∂Èó¥Ê†∑Âºè */
html.dark .publish-time {
    color: var(--el-text-color-primary);
}

.time-wrapper {
    position: relative;
    display: inline-block;
}

.time-ago-badge {
    position: absolute;
    top: -8px;
    right: -12px;
    font-size: 12px;
    padding: 1px 4px;
    border-radius: 8px;
    background: var(--el-color-primary-light-8);
    color: var(--el-color-primary);
    font-weight: 500;
    transform: scale(0.8);
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÊó∂Èó¥Èó¥ÈöîÊ†áÁ≠æÊ†∑Âºè */
html.dark .time-ago-badge {
    background: var(--el-color-primary-light-3);
    color: var(--el-color-primary-light-9);
}

/* Áâ©ÊµÅÂÆπÂô®Ê†∑Âºè */
.logistics-container {
    padding: 4px;
    width: 100%;
    position: relative;
    /* Ê∑ªÂä†Áõ∏ÂØπÂÆö‰Ωç */
}

.logistics-display {
    display: inline-flex;
    align-items: center;
    width: 100%;
    padding-right: 8px;
    /* Ê∑ªÂä†Âè≥ËæπË∑ùÔºå‰∏∫ÂæΩÊ†áÁïôÂá∫Á©∫Èó¥ */
}

.logistics-tag {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: visible;
    margin-right: 8px;
    /* Ê∑ªÂä†Âè≥ËæπË∑ùÔºå‰∏∫ÂæΩÊ†áÁïôÂá∫Á©∫Èó¥ */
}

.logistics-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.logistics-tag.is-active {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(var(--el-color-warning-rgb), 0.4);
    }

    70% {
        box-shadow: 0 0 0 10px rgba(var(--el-color-warning-rgb), 0);
    }

    100% {
        box-shadow: 0 0 0 0 rgba(var(--el-color-warning-rgb), 0);
    }
}

.logistics-icon {
    font-size: 16px;
    line-height: 1;
    flex-shrink: 0;
}

.logistics-text {
    font-weight: 500;
    flex-shrink: 0;
}

.logistics-badge {
    position: absolute;
    top: -6px;
    /* Ë∞ÉÊï¥‰∏äËæπË∑ù */
    right: -12px;
    /* Ë∞ÉÊï¥Âè≥ËæπË∑ù */
    min-width: 18px;
    /* Â¢ûÂä†ÊúÄÂ∞èÂÆΩÂ∫¶ */
    height: 18px;
    /* Â¢ûÂä†È´òÂ∫¶ */
    padding: 0 6px;
    /* Â¢ûÂä†Ê∞¥Âπ≥ÂÜÖËæπË∑ù */
    background-color: var(--el-color-primary);
    color: white;
    font-size: 12px;
    font-weight: bold;
    border-radius: 9px;
    /* Â¢ûÂä†ÂúÜËßí */
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transform: scale(0.9);
    /* Á®çÂæÆÁº©Â∞è‰∏ÄÁÇπ */
    z-index: 1;
    /* Á°Æ‰øùÊòæÁ§∫Âú®ÊúÄ‰∏äÂ±Ç */
}

.logistics-details {
    min-width: 300px;
    max-width: 400px;
    padding: 16px;
}

.logistics-item {
    padding: 8px;
    border-bottom: 1px solid var(--el-border-color-lighter);

    &:last-child {
        border-bottom: none;
    }
}

.logistics-item-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}

.logistics-number {
    font-family: 'Roboto Mono', monospace;
    font-size: 13px;
    color: var(--el-text-color-regular);
}

/* Tooltip Ê†∑Âºè‰ºòÂåñ */
:deep(.dark-tooltip) {
    background-color: var(--el-color-black) !important;
    color: var(--el-color-white) !important;
}

:deep(.light-tooltip) {
    background-color: var(--el-bg-color) !important;
    color: var(--el-text-color-primary) !important;
    border: 1px solid var(--el-border-color-light) !important;
    box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1) !important;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
html.dark {
    .logistics-tag {
        background-color: var(--el-bg-color);
        border-color: var(--el-border-color-darker);
    }

    .logistics-number {
        color: var(--el-text-color-secondary);
    }

    .logistics-details {
        background-color: var(--el-bg-color);
        border: 1px solid var(--el-border-color-darker);
    }

    .logistics-item {
        border-bottom-color: var(--el-border-color-darker);
    }

    .logistics-time {
        color: var(--el-text-color-secondary);
    }

    .logistics-badge {
        background-color: var(--el-color-primary);
        color: white;
    }
}

/* Âπ≥Âè∞Ê†áÁ≠æÁâπÂÆöÊ†∑Âºè */
:deep(.platform-tag.el-tag) {
    padding: 8px 15px !important;
    font-weight: 600 !important;
    border-radius: 20px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    text-transform: capitalize !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    min-width: 100px !important;
    justify-content: center !important;
    border: none !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}

/* Âπ≥Âè∞Ê†áÁ≠æÊ∏êÂèòËÉåÊôØ */
:deep(.platform-tag.el-tag--danger) {
    background: linear-gradient(45deg, #FF0000, #FF4444) !important;
    border: none !important;
    color: white !important;
}

:deep(.platform-tag.el-tag--warning) {
    background: linear-gradient(45deg, #C13584, #E1306C, #F77737) !important;
    border: none !important;
    color: white !important;
}

:deep(.platform-tag.el-tag--success) {
    background: linear-gradient(45deg, #25F4EE, #000000, #FE2C55) !important;
    border: none !important;
    color: white !important;
}

:deep(.platform-tag.el-tag--info) {
    background: linear-gradient(45deg, #1DA1F2, #14171A) !important;
    border: none !important;
    color: white !important;
}

:deep(.platform-tag.el-tag--primary) {
    background: linear-gradient(45deg, #4267B2, #898F9C) !important;
    border: none !important;
    color: white !important;
}

:deep(.platform-tag.el-tag--purple) {
    background: linear-gradient(45deg, #9146FF, #6441A4) !important;
    border: none !important;
    color: white !important;
}

/* Âπ≥Âè∞Ê†áÁ≠æÊÇ¨ÊµÆÊïàÊûú */
:deep(.platform-tag.el-tag:hover) {
    transform: translateY(-2px) scale(1.05) !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
    filter: brightness(1.1) !important;
}

/* Âπ≥Âè∞Ê†áÁ≠æÁÇπÂáªÊïàÊûú */
:deep(.platform-tag.el-tag:active) {
    transform: translateY(1px) scale(0.98) !important;
    filter: brightness(0.95) !important;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
html.dark {
    :deep(.platform-tag.el-tag--danger) {
        background: linear-gradient(45deg, #CC0000, #CC4422) !important;
    }

    :deep(.platform-tag.el-tag--warning) {
        background: linear-gradient(45deg, #962A6C, #C42E5A, #C45E2C) !important;
    }

    :deep(.platform-tag.el-tag--success) {
        background: linear-gradient(45deg, #1EC3BE, #000000, #CB2344) !important;
    }

    :deep(.platform-tag.el-tag--info) {
        background: linear-gradient(45deg, #1780C2, #10131A) !important;
    }

    :deep(.platform-tag.el-tag--primary) {
        background: linear-gradient(45deg, #324C85, #6B7179) !important;
    }

    :deep(.platform-tag.el-tag--purple) {
        background: linear-gradient(45deg, #7438CC, #503483) !important;
    }

    :deep(.platform-tag.el-tag) {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    }

    :deep(.platform-tag.el-tag:hover) {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
    }
}

/* Âπ≥Âè∞ÂõæÊ†áÂíåÊñáÊú¨Ê†∑Âºè */
.platform-icon {
    font-size: 18px !important;
    line-height: 1 !important;
}

.platform-text {
    font-size: 14px !important;
    letter-spacing: 0.5px !important;
    font-weight: 600 !important;
}
</style>
